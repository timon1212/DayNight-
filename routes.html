<!DOCTYPE html>
<html>
<head>
  <title>Routes & Delivery</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <a href="routes.html">Routes</a>
  <a href="inventory.html">Inventory</a>
  <a href="finance.html">Finance</a>
  <a href="gas.html">Gas</a>
  <a href="index.html" onclick="logout()">Logout</a>
</div>

<div class="content">
  <h2>Routes & Delivery</h2>

  <label>Choose Route:</label>
  <select id="routeSelect" onchange="displayRoute()"></select><br><br>

  <label>Add Stop:</label>
  <input type="text" id="stopName" placeholder="Stop Name">
  <input type="text" id="stopAddress" placeholder="Address">
  <button onclick="addStop()">Add Stop</button><br><br>

  <label>Assign Stock to Selected Stop:</label>
  <input type="number" id="stockAmount" placeholder="Qty">
  <select id="inventorySelect"></select><br><br>

  <div id="routeList"></div>
  <div id="map" style="height:400px;"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="app.js"></script>
<script>
checkLogin();

let map;
let markers = [];

initDB().then(async()=>{
  await initDefaults();
  await populateRoutes();
  await populateInventorySelect();
  initMap();
  displayRoute();
});

function logout() {
  localStorage.removeItem("currentUser");
  window.location.href = "index.html";
}

// ================= MAP =================
function initMap() {
  map = L.map('map').setView([30.45, -90.10], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data Â© OpenStreetMap contributors'
  }).addTo(map);
}

// ================= DISPLAY ROUTE =================
async function displayRoute() {
  const routeId = document.getElementById("routeSelect").value;
  if (!routeId) return;

  const routes = await getAll("routes");
  const route = routes.find(r => r.id == routeId);
  const div = document.getElementById("routeList");
  div.innerHTML = "";

  // Remove old markers
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  for (const [i, p] of route.pins.entries()) {
    const stockStr = p.stockAssigned.length
      ? p.stockAssigned.map(s => `${s.name}: ${s.qty}`).join(", ")
      : "No stock assigned";

    // Stop box
    const stopDiv = document.createElement("div");
    stopDiv.className = "stopBox";
    stopDiv.innerHTML = `
      <strong>${p.name}</strong> - ${p.address || ""}<br>
      <label><input type="checkbox" ${p.completed ? "checked" : ""} onchange="toggleStop(${route.id},${i},this.checked)">Completed</label><br>
      Stock: ${stockStr}<br>
      <button onclick="assignStockToStop(${i})">Assign Stock</button>
      <button onclick="removeStop(${i})">Remove Stop</button>
    `;
    div.appendChild(stopDiv);

    // Map pin
    let coords = p.coords || await getCoordinates(p.name);
    if (!coords) coords = [30.45, -90.10]; // fallback

    const marker = L.marker(coords, { draggable: true }).addTo(map);
    marker.bindPopup(`<strong>${p.name}</strong><br>${stockStr}`);
    markers.push(marker);

    // Drag to update coordinates
    marker.on('dragend', async (e) => {
      const newCoords = e.target.getLatLng();
      route.pins[i].coords = [newCoords.lat, newCoords.lng];
      await updateData("routes", route);
      marker.setPopupContent(`<strong>${p.name}</strong><br>${stockStr}<br>Moved to: ${newCoords.lat.toFixed(5)}, ${newCoords.lng.toFixed(5)}`);
    });

    // Right-click to remove pin
    marker.on('contextmenu', async () => {
      if(confirm(`Remove stop "${p.name}"?`)){
        route.pins.splice(i,1);
        await updateData("routes", route);
        displayRoute();
      }
    });
  }
}

// Remove stop from list
async function removeStop(index){
  const routeId = document.getElementById("routeSelect").value;
  const routes = await getAll("routes");
  const route = routes.find(r => r.id == routeId);
  if(!confirm(`Are you sure you want to remove "${route.pins[index].name}"?`)) return;
  route.pins.splice(index,1);
  await updateData("routes", route);
  displayRoute();
}

// ================= COORDINATES =================
async function getCoordinates(stopName){
  const stops = await fetch("stops.json").then(res=>res.json());
  const stop = stops.find(s => s.stop === stopName);
  if(stop) return [stop.lat, stop.lon];
  return [30.45, -90.10]; // fallback
}
</script>

</body>
</html>
